//Cylaris TRG: ProxyNotShell Exchange W3CIISLog Exploit Indicators -- CVE-2022-40140, CVE-2022-41082 -- CC-4178
//ver 1.0
//falsepositive-rate: Untested
//contact:extcomms@cylaris.org
//references: GTSC SOC > https://www.gteltsc.vn/blog/canh-bao-chien-dich-tan-cong-su-dung-lo-hong-zero-day-tren-microsoft-exchange-server-12714.html
W3CIISLog
| where (csUserAgent matches regex @‘(?i)^antsword\/v\d{1}(\.\d{1,2})$’ and csUriStem contains "/owa/auth/redirsuiteserviceproxy.aspx") or (csUriQuery contains "powershell") or (csUriQuery matches regex @'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d{2,5})?\/.*?\.(aspx)?') or (csUriStem has_any ("DrSDKCaller.exe","all.exe","dump.dll","ad.exe","gpg-error.exe","cm.exe","msado32.tlb"))
