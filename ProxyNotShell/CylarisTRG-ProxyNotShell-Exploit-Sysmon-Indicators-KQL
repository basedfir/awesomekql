//Cylaris TRG: ProxyNotShell Exchange Sysmon Exploit Indicators -- CVE-2022-40140, CVE-2022-41082 -- CC-4178
//ver 1.0
//falsepositive-rate: Untested
//contact:extcomms@cylaris.org
// Make sure to edit 'sysmon' table and 'process_command_line' to the appropriate table and column you have parsed sysmon if not default
Sysmon
| where process_command_line matches regex @'(?i)\w{1}:\\{1,2}perflogs.?&certutil(\.exe)?\s(-urlcache\s)?(-split\s)?(-urlcache\s)?(-split\s)?(-f\s)?http(s)?:\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d{1,5})?\/.*?\.aspx(\s\w{1}:)?'
