//Cylaris TRG: ProxyNotShell Exchange Sysmon Exploit Indicators -- CVE-2022-40140, CVE-2022-41082 -- CC-4178
//ver 1.1
//falsepositive-rate: Untested
//contact:extcomms@cylaris.org
//references: GTSC SOC > https://www.gteltsc.vn/blog/canh-bao-chien-dich-tan-cong-su-dung-lo-hong-zero-day-tren-microsoft-exchange-server-12714.html
// Make sure to edit 'sysmon' table and 'process_command_line' to the appropriate table and column you have parsed sysmon if not default
Sysmon
| where process_command_line matches regex @'(?i)\w{1}:\\{1,2}perflogs.?&certutil(\.exe)?\s(-urlcache\s)?(-split\s)?(-urlcache\s)?(-split\s)?(-f\s)?http(s)?:\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d{1,5})?\/.*?\.aspx(\s\w{1}:)?'
